---
layout: single
title: " [운영체제] 시스템 구조(1)"
categories: CS
tags:
  - CS
  - OperatingSystems
toc: true
toc_sticky: true
author_profile: false
sidebar:
---
# System Structure & Program Execution
컴퓨터 시스템에서 하드웨어가 어떻게 동작하고 프로그램들이 하드웨어 위에서 어떻게 돌아가는지에 대한 내용

## Mode bit
- 사용자 프로그램의 잘못된 수행으로 (해킹 등) 다른 프로그램 및 운영체제에 피해가 가지 않도록 하기 위한 장치 필요
- Mode bit을 통해 하드웨어적으로 두 가지 모등의 operation 지원
```
1 사용자 모드 : 사용자 프로그램 수행
0 모니터 모드 : OS 코드 수행 
```
- 보안을 해칠 수 있는 중요한 명령어는 모니터 모드에서만 수행 가능한 **특권명령**으로 규정
	- 모드 빗이 0일 때는 (운영체제) 무슨 일이든 다 함 io디바이스 나 메모리 모두 접근 가능
	- 1 일 때는 사용자 프로그램이므로 제안된 인스트럭션만 실행
- interrupt나 exception발생시 하드웨어가 mode bit을 0으로 바꿈
- 사용자 프로그램에게 cpu를 넘기기 전에 mode bit을 1로 셋팅

![](https://i.imgur.com/yguPaJX.png)

- mode bit의 역할 -> 0 일 때는 무슨 일이든 다 할 수 있음 io디바이스 및 메모리등 모두 접근권한이 다 있음
- 1 일때는 제한

## Timer
- 타이머
	- 특정 사용자 프로그램이 cpu 를 독점하는 걸 막기 위해 사용
	- 정해진 시간이 흐른 뒤 운영체제에게 제어권이 넘어가도록 인터럽트를 발생시킴
	- 타이머는 매 클럭 틱 마다 1씩 감소
	- 타이머 값이 0이 되면 타이머 인터럽트 발생
	- CPU를 특정 프로그램이 독점하는 것으로부터 보호
- 타이머는 time sharing 을 구현하기 위해 널리 이용됨
- 타이머는 현재 시간을 계산하기 위해서도 사용

## Device Controller
- I/O device controller
	- 해당 I/O 장치 유형을 관리하는 일종의 작은 CPU
	- 제어 정보를 위해 control register, status register를 가짐
	- local buffer를 가짐 (일종의 data register)
- I/O는 실제 device와 local buffer 사이에서 일어남
- Device controller 는 I/O가 끝났을 경우 interrupt로 CPU에 그 사실을 알림

- device driver (장치구동기)
	- OS 코드 중 각 장치별 처리루틴 -> software
	- cpu가 디바이스 컨트롤러를 수행하기 위해 존재
	- 실제로 디바이스 드라이버를 수행하는건 아니고 디바이스 컨트롤러가 지시 받아서 수행하고 디바이스 드라이버가 일하는건 펌웨어가 함
- device controller (장치제어기)
	- 각 장치를 통제하는 일종의 작은 CPU -> hardware

## 입출력(I/O)의 수행
- 모든 입출력 명령은 특권 명령
- 사용자 프로그램은 어떻게 I/O를 하는가?
	- 시스템콜(system call)
		- 사용자 프로그램은 운영체제에게 I/O 요청
	- trap을 사용하여 인터럽트 백터의 특정 위치로 이동
		- 본인이 직접 데이터를 못 불러 오기 때문에 운영체제한테 일을 시킬 수 있도록 인터룹트를 거는 것 그래서 본인이 사용하다가 os에게 cpu가 넘어가게 함
	- 제어권이 인터럽트 벡터가 가리키는 인터럽트 서비스 루틴으로 이동
	- 올바른 I/O 요청인지 확인 후 I/O 수행
	- I/O 완료시 제어권을 시스템 콜 다음 명령으로 옮김

## 시스템 콜
- 사용자 프로그램이 운영체제의 서비스를 받기 위해 커널 함수를 호출하는 것

![](https://i.imgur.com/76IWux8.png)

## 인터럽트 (Interrupt)
- 인터럽트
	- 인터럽트 당한 시점의 레지스터와 program counter를 save한 후 CPU 의 제어를 인터럽트 처리 루틴에 넘긴다
- Interrupt (넓은 의미)
	- Interrupt (하드웨어 인터럽트) : 하드웨어가 발생시킨 인터럽트
	- Trap(소프트웨어 인터럽트)
		- Exception : 프로그램이 오류를 범한 경우
		- System call : 프로그램이 커널 함수를 호출하는 경우
- 인터럽트 관련 용어
	- 인터럽트 백터
		- 해당 인터럽트의 처리 루틴 주소를 가지고 있음
	- 인터럽트 처리 루틴
		- (=interrupt Service Routine, 인터럽트 핸들러)
		- 해당 인터럽트를 처리하는 커널 함수
- 타이머 혹은 디바이스 컨트롤러가 인터룹트를 걸고 이런 방식 때문에 현대 운영체제는 인터룹트에 의해 구동됨

## 정리 

![](https://i.imgur.com/mq7zz0L.png)

- 오른쪽 컴퓨터 프린터 키보드 마우스 하드디스크 이런건 I/O 디바이스로 인풋 아웃풋 
	- 각 디바이스에는 전담하는 작은 cpu가 있는데 이를 device controller라고 하고 디스크의 내부를 통제하는건 cpu가 아니라 device controller가 수행함
	- 디바이스 컨트롤러도 cpu의 메모리처럼 작업 공간이 필요한데 이를 local buffer라고 함
- 메모리는 cpu의 작업 공간
- cpu는 매 순간 매 클럭 사이클마다 메모리에서 인스터럭션 (기계어)를 읽어서 하나씩 실행함
- cpu에는 메모리보다 더 빠른 작업공간이 있는데 이를 register라고 함
- mode bit은 지금 실행되는게 운영체제 인지 사용자 프로그램인지 구분해줌
- cpu는 메모리하고만 작업을 하는데 예를 들어 i/o 디바이스의 입력 값을 받아와야할 경우 cpu는 디바이스 컨트롤러에 일을 시키고 다음 작업을 진행함
- (cpu는 아주아주 빠르기 때문에 키보드 입력 속도를 기다리는건 매우 느려서 일 시켜 놓고 다른 일 함)만약 프로그램 A가 무한루프같은 작업을 시행할 경우 cpu의 자원이 한 곳에만 뺏기므로 timer를 통해 일정시간이 지나면 다른 작업으로 넘어가게 만듦 
	- 이 때 인터룹트 라인을 걺 이 때 하던 일을 멈추고 다음 걸로 넘어감(timer에 세팅된 값은 수십밀리세컨드로 매우 짧음)
- 이런 과정에서 메모리에 있는 인스트럭션을 확인하면서 인터룹트 라인도 함께 확인한다. 인터룹트 라인에 들어온게 없다면 다음 인스트럭션을 진행함
- 타이머가 인터풉트를 걸어오면 하던 일을 멈추고 운영체제로 자동으로 넘어감 한 번 넘어가면 뺏어올 수 없음 왜냐하면 운영체제가 따로 cpu가 없기 때문
- 이 때 운영체제가 다음 프로그램으로 cpu 제어권을 넘겨줌 운영체제는 타이머를 통해 계속 자원을 관리함
- 사용자 프로그램이 i/o 디바이스를 통해 어떤 값이 필요할 경우 얘네는 직접 뭘 할 수 가 없어서 (직접적인 접근이 안됨) 운영체제에게 cpu를 또 넘겨줘서 값 좀 받아오라고 함 왜냐하면 운영체제를 통해서만 데이터를 받아올 수 있음 (보안 및 여러 이유)
- i/o작업은 매우 느리므로 운영체제는 또 다른 프로그램에게 cpu를 넘겨줌 이 때 사용자 프로그램은 대기중이다가 i/o 디바이스에서 해당 작업이 끝났ㅇ즐 경우 그 작업은 로컬 버퍼로 가고 이걸 감지한 디바이스 컨트롤러는 cpu 에게 인터룹트를 걸음 그러면 cpu는 인터룹트 라인을 확인하고 다시 운영체제에게 cpu를 넘겨줌 그러면 운영체제가 갑자기 얘가 왜 왔지?하면서 살펴보고 아까 사용자 프로그램이 요청했던 i/o디바이스 값 달라고 했구나 하고 그 요청했던 값을 사용자 프로그램 메모리 공간에 값을 카피해줌 그리고 해당 사항이 끝났을 경우 이전에 중단된 사용자 프로그램의 타이머가 남아 있다면 그 프로그램에게 다시 넘겨줌
- 근데 이렇게 될 경우 cpu가 i/o장치에 너무 많은 방해를 받게 되고 이렇게 되면 비효율적이라 DMA 컨트롤러가 존재함
- DMA 컨트롤러는 cpu가 계속 일하게 만들고 로컬 버퍼에 들어온 내용을 본인이 메모리에 올린다음 cpu에게 알려줌 이렇게 해서 중간에 cpu가 일하는 걸 방해하는 빈도를 줄일 수 있게 됨
- 이 때 cpu와 DMA 컨트롤러가 동시에 메모리에 접근할 수 있으므로  일관성이 깨지는 문제가 생긴다 이 때 바로 메모리 컨트롤러가 중재함



[출처 링크](https://core.ewha.ac.kr/publicview/C0101020140311132925816476?vmode=f)

